// CONFIGURAÃ‡ÃƒO
const API_URL = 'https://script.google.com/macros/s/AKfycbzDI5z4TcBhjEHbmVwtnmk3gTK2oFK6NKJaG8mxTGTKndUp7XxydFTajo9SegbBLi5a/exec';
const REDIRECT_URL = 'https://ozoxxvenda.github.io/pagina-de-captura/home.html'; // URL do seu site principal
const GA_ID = 'G-8D4M7PEGKL'; // Seu ID do Google Analytics

// INICIALIZAR
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('leadForm');
  const submitBtn = document.getElementById('submitBtn');
  const loading = document.getElementById('loading');
  
  // Verificar se jÃ¡ preencheu (opcional)
  if (localStorage.getItem('ozoxx_access')) {
    // Se jÃ¡ acessou antes, redireciona direto
    window.location.href = REDIRECT_URL;
    return;
  }
  
  // CONFIGURAR TRACKING DE MÃ‰TRICAS
  setupMetrics();
  
  // ENVIO DO FORMULÃRIO
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Desativar botÃ£o
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processando...';
    loading.style.display = 'block';
    
    // Coletar dados
    const formData = {
      nome: form.nome.value.trim(),
      tel: form.tel.value.trim(),
      email: form.email.value.trim()
    };
    
    console.log('ðŸ“¤ Enviando dados:', formData);
    
    try {
      // ENVIAR PARA GOOGLE SHEETS
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(formData).toString()
      });
      
      const result = await response.json();
      console.log('ðŸ“¥ Resposta da API:', result);
      
      if (result.success) {
        // âœ… SUCESSO
        trackConversion('complete'); // GA
        saveMetrics('complete'); // MÃ©tricas locais
        
        // Marcar como preenchido
        localStorage.setItem('ozoxx_access', 'true');
        localStorage.setItem('ozoxx_user', formData.nome);
        
        // Redirecionar
        setTimeout(() => {
          window.location.href = REDIRECT_URL;
        }, 1000);
        
      } else {
        // âŒ ERRO
        throw new Error(result.message || 'Erro desconhecido');
      }
      
    } catch (error) {
      console.error('âŒ Erro no envio:', error);
      
      // Restaurar botÃ£o
      submitBtn.disabled = false;
      submitBtn.textContent = 'ðŸ‘‰ Acessar Agora';
      loading.style.display = 'none';
      
      // Mostrar erro amigÃ¡vel
      alert('âŒ Ocorreu um erro. Por favor, tente novamente.\nErro: ' + error.message);
      
      // Track error
      trackConversion('error');
    }
  });
  
  // MONITORAR PREENCHIMENTO PARCIAL
  setupFormTracking(form);
});

// CONFIGURAR TRACKING DE PREENCHIMENTO
function setupFormTracking(form) {
  const fields = ['nome', 'tel', 'email'];
  let filled = { nome: false, tel: false, email: false };
  
  fields.forEach(fieldName => {
    const field = form[fieldName];
    
    field.addEventListener('blur', function() {
      const hasValue = this.value.trim().length > 0;
      filled[fieldName] = hasValue;
      
      // Contar inÃ­cio do formulÃ¡rio
      if (Object.values(filled).some(v => v === true)) {
        if (!localStorage.getItem('form_started')) {
          localStorage.setItem('form_started', 'true');
          trackConversion('start');
          saveMetrics('start');
        }
      }
      
      // Detectar preenchimento parcial (nome + tel sem email)
      if (filled.nome && filled.tel && !filled.email) {
        if (!localStorage.getItem('partial_fill')) {
          localStorage.setItem('partial_fill', 'true');
          trackConversion('partial');
          saveMetrics('partial');
        }
      }
    });
  });
  
  // Contar abandono (usuÃ¡rio sai sem enviar)
  window.addEventListener('beforeunload', function() {
    const started = localStorage.getItem('form_started');
    const completed = localStorage.getItem('form_completed');
    
    if (started && !completed) {
      saveMetrics('abandon');
      trackConversion('abandon');
    }
  });
}

// SALVAR MÃ‰TRICAS NO LOCALSTORAGE
function saveMetrics(type) {
  const now = new Date().toISOString();
  const metrics = JSON.parse(localStorage.getItem('ozoxx_metrics') || '{
    "visits": 0,
    "starts": 0,
    "partial": 0,
    "completes": 0,
    "abandons": 0,
    "errors": 0,
    "history": []
  }');
  
  // Incrementar contadores
  if (type === 'visit') metrics.visits++;
  if (type === 'start') metrics.starts++;
  if (type === 'partial') metrics.partial++;
  if (type === 'complete') metrics.completes++;
  if (type === 'abandon') metrics.abandons++;
  if (type === 'error') metrics.errors++;
  
  // Adicionar ao histÃ³rico
  metrics.history.push({
    type: type,
    time: now,
    page: window.location.href
  });
  
  // Manter histÃ³rico limitado
  if (metrics.history.length > 100) {
    metrics.history = metrics.history.slice(-50);
  }
  
  localStorage.setItem('ozoxx_metrics', JSON.stringify(metrics));
  
  // Enviar para Google Sheets periodicamente (opcional)
  if (metrics.completes % 5 === 0) {
    sendMetricsToSheets(metrics);
  }
}

// ENVIAR MÃ‰TRICAS PARA SHEETS (separado)
function sendMetricsToSheets(metrics) {
  const metricsData = {
    date: new Date().toLocaleString('pt-BR'),
    visits: metrics.visits,
    starts: metrics.starts,
    partial: metrics.partial,
    completes: metrics.completes,
    conversion: metrics.starts > 0 ? 
      ((metrics.completes / metrics.starts) * 100).toFixed(2) + '%' : '0%'
  };
  
  // Enviar para outra aba da mesma planilha
  fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: 'metrics',
      data: metricsData
    })
  }).catch(e => console.log('Erro mÃ©tricas:', e));
}

// GOOGLE ANALYTICS
function trackConversion(action) {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'conversion', {
      'event_category': 'lead_form',
      'event_label': action,
      'value': 1
    });
  }
}

// CONTAGEM DE VISITAS (executar na primeira carga)
function setupMetrics() {
  const lastVisit = localStorage.getItem('last_visit');
  const now = new Date();
  
  // Contar nova visita (se passou +30min)
  if (!lastVisit || (now - new Date(lastVisit)) > 30 * 60 * 1000) {
    saveMetrics('visit');
  }
  
  localStorage.setItem('last_visit', now.toISOString());
  
  // DEBUG: Ver mÃ©tricas no console
  console.log('ðŸ“Š MÃ©tricas atuais:', 
    JSON.parse(localStorage.getItem('ozoxx_metrics') || '{}'));
}
